<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Example confidence Distribution</title>
    <style type="text/css">
        #Instructions {
            text-align: center;
            height: 2em;
        }
        #Interface {
            display: inline-flex;
        }
        #LeftPanel {
            min-width: 850px;
        }
        #RightPanel {
            width: 150px;
            color: white;
            font-size: 20px;
        }
        #Wrapper {
            display: block;
            margin: auto;
            width: 1000px;
            position: fixed;
            top: 50%;
            left: 50%;
            /* bring your own prefixes */
            transform: translate(-50%, -50%);
        }
        .counter {
            text-align: right;
            font-weight: bold;
            font-size: 1.2em;
        }
        body {
            background-color: black;
            color: white;
        }
        button {
            display: block;
            margin: auto;
            margin-top: 1.5em;
            width: 100%;
            height: 2em;
            border: none;
            background-color: whitesmoke;
            font-size: 1em;
        }
        button:disabled {
            display: none;
        }
        canvas {
            border: 5px solid black;
            margin: auto;
            display: block;
            background-color: white;
        }
        p {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div id="Wrapper">
        <div id="Instructions">
            <p><em>Click on the panel to mark your guess, then press 'show result' to see the result.</em></p>
        </div>
        <div id="Interface">
            <div id="LeftPanel" class="panel">
                <canvas width="808" height="500" id="myCanvas"></canvas>
            </div>
            <div id="RightPanel" class="panel">
                <div class="scores">
                    <p class="label">Round #:</p>
                    <p class="counter"><span id="RoundCounter">1</span></p>
                    <p class="label">Current score:</p>
                    <p class="counter"><span id="ScoreCounter">0</span></p>
                    <p class="label">Score/round:</p>
                    <p class="counter"><span id="Average">0</span></p>
                </div>
                <button onclick="clickButton()" id="ShowResultButton" disabled="disabled">(S)how result</button>
                <button onclick="nextRound()" id="NextRoundButton" disabled="disabled">(N)ext round</button>
            </div>
        </div>
    </div>

    <script type="module">
        import {Distribution} from "./src/distribution.js";

        window.buttons = {
            showResults: document.getElementById('ShowResultButton'),
            nextRound: document.getElementById('NextRoundButton')
        };

        window.round = 0;

        window.dist = new Distribution({
            canvas: document.getElementById('myCanvas'),
            xMin: 0,
            xMax: 100,
            minPrecision: .25,
            maxPrecision: .90,
            style: {
                gutterX: 5,
                gutterY: 15,
                paddingX: 40,
                paddingY: 40,
                axisTickSizeX: 10,
                precisionPadding: .05,
                precisionStart: .15,
                showWidgetLabel: true
            },
            callback: {
                onUpdate: ()=>window.enableAnswerButton()
            }
        }).drawAxisX();

        window.nextRound = function() {
            window.dist = new Distribution(window.dist).clearCanvas().drawAxisX();
            window.round += 1;
            document.getElementById("RoundCounter").innerText = window.round.toString();
            buttons.nextRound.disabled = true;
        }
    </script>
    <script type="text/javascript">
        let answerMean = null;
        let answerSD = null;

        function getAnswer() {
            let recalculateAnswer = Math.random() < .2; // 20% chance of changing the mean of the answers
            if(answerMean === null || recalculateAnswer) {
                answerMean = answerMean = dist.xMin + Math.round((dist.xMax - dist.xMin)*Math.random());
                answerSD = (dist.xMax - dist.xMin) / 16;
            }

            // generate answer
            let answer = -Infinity;
            while(answer < dist.xMin || answer > dist.xMax) {
                // answer is a random z score generated by summing 12 random variables
                // thanks SE: https://stats.stackexchange.com/questions/16334/how-to-sample-from-a-normal-distribution-with-known-mean-and-variance-using-a-co
                answer = 0;
                for(let i = 0; i < 12; i++)
                    answer += Math.random();
                answer -= 6; // subtract the mean to leave the z score between -6 and 6
                // and convert z score to real score
                answer *= answerSD;
                answer += answerMean;
                answer = Math.round(answer);
                // console.log('answerMean: ' + answerMean + "; answer: " + answer);
            }
            return answer;
        }

        function clickButton() {
            let answer = getAnswer();
            dist.showResult(answer);
            // disable canvas interactions
            dist.canvas.registerClickMouse(false);
            // update score
            let score = parseFloat(document.getElementById('ScoreCounter').innerText);
            score += parseFloat(dist.yToPayout(dist.y[dist.x.indexOf(answer)]).toFixed(2));
            if(isNaN(score))
                score = 0;
            document.getElementById('ScoreCounter').innerText = score.toFixed(2);
            let rounds = parseFloat(document.getElementById('RoundCounter').innerText);
            let mean = score/rounds;
            if(isNaN(mean))
                mean = 0;
            document.getElementById('Average').innerText = mean.toFixed(2);
            // enable next round button
            buttons.nextRound.disabled = false;
            buttons.showResults.disabled = true;
        }

        window.enableAnswerButton = function() {
            buttons.showResults.disabled = false;
        };

        // keypresses:
        window.onkeypress = function(keyEvent) {
            let key = String.fromCharCode(keyEvent.which || keyEvent.keyCode).toLowerCase();
            if(key === 's') {
                if(buttons.showResults.disabled === false)
                    clickButton();
            } else if(key === 'n') {
                if(buttons.nextRound.disabled === false)
                    nextRound();
            }
        }
    </script>
</body>
</html>